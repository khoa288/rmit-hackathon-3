<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Mic + Laughter Scorer (100% in-browser)</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 2rem; }
  .row { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
  button { padding: .75rem 1rem; font-size: 1rem; border-radius: .75rem; border: 1px solid #cbd5e1; background:#f8fafc; cursor:pointer }
  button.primary { background:#111827; color:#fff; border-color:#111827 }
  .mono { font-variant-numeric: tabular-nums; font-feature-settings:"tnum"; }
  .ok { color:#16a34a } .bad{ color:#ef4444 } .warn{ color:#eab308 } .muted{ color:#6b7280 }
  .bar { height: 14px; background:#e5e7eb; border-radius:999px; overflow:hidden; width: 360px; max-width: 100%; }
  .fill { height:100%; width:0%; background: linear-gradient(90deg,#93c5fd,#2563eb); transition: width .12s linear; }
  .fill.green { background: linear-gradient(90deg,#86efac,#16a34a); }
  .fill.yellow { background: linear-gradient(90deg,#fde68a,#f59e0b); }
  pre { background:#0b1220; color:#e5e7eb; padding: .75rem 1rem; border-radius: .5rem; overflow:auto }
</style>

<h1>Microphone + Laughter Scorer</h1>
<p class="muted">Enable mic â†’ see live RMS and <b>Laughter %</b> (on-device YAMNet). HappyScore = EMA(laughter) Ã— 100. This page is for testing only.</p>

<div class="row">
  <button id="enable" class="primary">Enable Microphone</button>
  <button id="stop" disabled>Stop</button>
  <span id="status">Idle.</span>
</div>

<p>
  Secure context: <b id="secure" class="mono"></b> Â·
  Origin: <span class="mono" id="origin"></span> Â·
  Permission (if supported): <b id="perm" class="mono">n/a</b>
</p>

<div class="row" style="margin:.5rem 0 1rem">
  <div class="bar"><div id="level" class="fill"></div></div>
  <span class="mono" id="rms">RMS 0.000</span>
</div>

<div class="row" style="margin:.25rem 0 1rem">
  <div class="bar" title="Laughter probability"><div id="laughBar" class="fill green"></div></div>
  <span class="mono" id="laugh">Laughter 0.0%</span>
</div>

<div class="row" style="margin:.25rem 0 1.25rem">
  <div class="bar" title="HappyScore (EMA of laughter Ã— 100)"><div id="happyBar" class="fill yellow"></div></div>
  <span class="mono" id="happy">HappyScore 0</span>
</div>

<p class="muted">10s running average (for sanity): <span class="mono" id="avg10">0.0%</span></p>

<details>
  <summary>How to fix if blocked</summary>
  <ul>
    <li>Chrome/Edge: click the <b>ðŸ”’</b> in the address bar â†’ <b>Site settings</b> â†’ Microphone: <b>Allow</b>. Then reload.</li>
    <li>Safari (macOS): Safari â†’ <b>Settings for This Websiteâ€¦</b> â†’ Microphone: <b>Allow</b>. Also macOS Settings â†’ Privacy & Security â†’ Microphone.</li>
    <li>iOS/iPadOS: Settings â†’ Safari â†’ Camera & Microphone â†’ <b>Allow</b>. Also Settings â†’ Privacy â†’ Microphone.</li>
  </ul>
</details>

<h3>Debug log</h3>
<pre id="log" class="mono"></pre>

<script>
const $ = s => document.querySelector(s);
const log = (m)=>{$('#log').textContent += m + "\n"}

const isSecure = () =>
  window.isSecureContext || location.protocol === 'https:' ||
  location.hostname === 'localhost' || location.hostname === '127.0.0.1';

$('#origin').textContent = location.origin;
$('#secure').textContent = isSecure();
$('#secure').className = isSecure() ? 'ok' : 'bad';

(async () => {
  try {
    const p = await navigator.permissions?.query?.({ name: 'microphone' });
    if (p) {
      $('#perm').textContent = p.state;
      $('#perm').className = (p.state === 'granted') ? 'ok' : (p.state === 'denied') ? 'bad' : 'warn';
      p.onchange = () => {
        $('#perm').textContent = p.state;
        $('#perm').className = (p.state === 'granted') ? 'ok' : (p.state === 'denied') ? 'bad' : 'warn';
      };
    } else { $('#perm').textContent = 'unsupported'; $('#perm').className = 'muted'; }
  } catch(e) { $('#perm').textContent = 'error'; $('#perm').className = 'muted'; }
})();

let ctx, src, analyser, buf, raf;
let tf, yamnetModel, ring, ridx = 0, procNode;
let ema = null, sum10 = 0, count10 = 0, avgTimer;
const EMA_ALPHA = 0.2; // smoother = smaller

function startMeter(stream) {
  const AC = window.AudioContext || window.webkitAudioContext;
  ctx = new AC({ sampleRate: 16000 });
  const track = stream.getAudioTracks()[0];
  if (!track) throw new Error('NO_TRACK');
  src = ctx.createMediaStreamSource(stream);
  analyser = ctx.createAnalyser(); analyser.fftSize = 1024;
  buf = new Float32Array(analyser.fftSize);
  src.connect(analyser);

  // ring buffer ~1.0s @16k for YAMNet
  ring = new Float32Array(16000); ridx = 0;
  procNode = ctx.createScriptProcessor(16384, 1, 1);
  src.connect(procNode); procNode.connect(ctx.destination);
  procNode.onaudioprocess = (e) => {
    const x = e.inputBuffer.getChannelData(0);
    for (let i=0;i<x.length;i++){ ring[ridx++] = x[i]; if (ridx===ring.length) ridx=0; }
  };

  function tick() {
    analyser.getFloatTimeDomainData(buf);
    let s=0; for (let i=0;i<buf.length;i++) s+=buf[i]*buf[i];
    const rms = Math.sqrt(s/buf.length);
    $('#rms').textContent = 'RMS ' + rms.toFixed(3);
    $('#level').style.width = Math.min(100, rms*200) + '%';
    raf = requestAnimationFrame(tick);
  }
  tick();
}

async function loadYamnet() {
  // Load TFJS + YAMNet via CDN (no build tools)
  if (!window.tf) {
    await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
  }
  tf = window.tf;
  await new Promise((res,rej)=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/@tensorflow-models/yamnet@1.0.1/dist/yamnet.min.js'; s.onload=res; s.onerror=rej; document.head.appendChild(s); });
  yamnetModel = await window.yamnet.load();
  log('YAMNet loaded.');
}

function slice1sFromRing() {
  const out = new Float32Array(16000);
  const tail = ring.length - ridx;
  out.set(ring.subarray(ridx), 0);
  out.set(ring.subarray(0, ridx).subarray(0, 16000 - tail), tail);
  return out;
}

async function classifyLoop() {
  // every ~250ms: get 1s slice, run model, read laughter prob
  const dt = 250;
  let lastTs = performance.now();
  function step() {
    const now = performance.now();
    if (now - lastTs >= dt) {
      lastTs = now;
      const slice = slice1sFromRing();
      yamnetModel.predict(slice).then(res => {
        // res may be array [scores, embeddings, spectrogram] or object; normalize to scores Float32Array
        const scores = Array.isArray(res) ? res[0] : res.scores;
        const labels = window.yamnet.YAMNET_CLASSES;
        // find laughter-ish labels
        let pLaugh = 0, c=0;
        for (let i=0;i<labels.length;i++){
          const n = labels[i].toLowerCase();
          if (n.includes('laughter') || n.includes('giggl')) { pLaugh += scores[i]; c++; }
        }
        pLaugh = c ? pLaugh/c : 0;

        // EMA smoothing
        ema = (ema === null) ? pLaugh : (ema*(1-EMA_ALPHA) + pLaugh*EMA_ALPHA);

        // UI
        const laughPct = Math.round(pLaugh * 100);
        const happyScore = Math.round((ema||0) * 100);
        $('#laugh').textContent = `Laughter ${laughPct}%`;
        $('#laughBar').style.width = Math.min(100, laughPct) + '%';
        $('#happy').textContent = `HappyScore ${happyScore}`;
        $('#happyBar').style.width = Math.min(100, happyScore) + '%';

        // 10s running average just for sanity
        sum10 += pLaugh; count10++;
        const win = Math.min(40, count10); // ~40 ticks â‰ˆ 10s
        const avg = (sum10 / count10) * 100;
        $('#avg10').textContent = avg.toFixed(1) + '%';
      }).catch(err => console.warn('predict err', err));
    }
    if (running) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

$('#enable').onclick = async () => {
  $('#status').textContent = 'Requesting microphoneâ€¦';
  $('#status').className = '';
  $('#log').textContent = '';

  if (!isSecure()) {
    $('#status').textContent = 'Not a secure context. Use HTTPS or http://localhost.';
    $('#status').className = 'bad';
    alert('Microphone requires HTTPS or http://localhost.\nOpen via GitHub Pages (HTTPS) or a local server.');
    return;
  }

  try {
    // iOS/Safari: start AudioContext inside this gesture
    const AC = window.AudioContext || window.webkitAudioContext;
    const tmp = new AC({ sampleRate: 16000 });
    if (tmp.state === 'suspended') await tmp.resume();
    tmp.close();

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    $('#status').textContent = 'Microphone active. Loading YAMNetâ€¦';
    $('#status').className = 'ok';
    $('#enable').disabled = true; $('#stop').disabled = false;
    log('Got stream: ' + JSON.stringify(stream.getAudioTracks()[0].getSettings()));
    startMeter(stream);
    await loadYamnet();
    $('#status').textContent = 'Scoring laughter on-device.';
    running = true;
    classifyLoop();
  } catch (e) {
    console.error(e);
    let msg = 'Could not access the microphone.';
    if (e.name === 'NotAllowedError' || e.name === 'SecurityError') {
      msg = 'Permission denied. Click the lock icon â†’ Site settings â†’ Microphone: Allow, then reload.';
      $('#status').className = 'bad';
    } else if (e.name === 'NotFoundError' || e.message === 'NO_TRACK') {
      msg = 'No microphone found. Select a valid input device in browser settings.';
      $('#status').className = 'bad';
    } else if (e.message && e.message.includes('secure')) {
      msg = 'Secure context required. Use HTTPS or http://localhost.';
      $('#status').className = 'bad';
    } else {
      $('#status').className = 'warn';
    }
    $('#status').textContent = msg;
    alert(msg);
    log(e.name + ': ' + (e.message || ''));
  }
};

let running = false;
$('#stop').onclick = () => {
  running = false;
  cancelAnimationFrame(raf);
  try { ctx && ctx.close(); } catch(_) {}
  $('#enable').disabled = false; $('#stop').disabled = true;
  $('#status').textContent = 'Stopped.';
  $('#status').className = '';
};
</script>
