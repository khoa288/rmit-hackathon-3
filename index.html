<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Microphone Debug (HTTPS/localhost only)</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 2rem; }
  .row { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
  button { padding: .75rem 1rem; font-size: 1rem; border-radius: .75rem; border: 1px solid #cbd5e1; background:#f8fafc; cursor:pointer }
  button.primary { background:#111827; color:#fff; border-color:#111827 }
  .mono { font-variant-numeric: tabular-nums; font-feature-settings:"tnum"; }
  .ok { color:#16a34a } .bad{ color:#ef4444 } .warn{ color:#eab308 } .muted{ color:#6b7280 }
  .bar { height: 14px; background:#e5e7eb; border-radius:999px; overflow:hidden; width: 360px; max-width: 100%; }
  .fill { height:100%; width:0%; background: linear-gradient(90deg,#93c5fd,#2563eb); }
  pre { background:#0b1220; color:#e5e7eb; padding: .75rem 1rem; border-radius: .5rem; overflow:auto }
</style>

<h1>Microphone Access Debug</h1>
<p class="muted">This page checks only one thing: can this browser give us a microphone stream <b>after a user click</b>?</p>

<div class="row">
  <button id="enable" class="primary">Enable Microphone</button>
  <button id="stop" disabled>Stop</button>
  <span id="status">Idle.</span>
</div>

<p>
  Secure context: <b id="secure" class="mono"></b> Â·
  Origin: <span class="mono" id="origin"></span> Â·
  Permission (if supported): <b id="perm" class="mono">n/a</b>
</p>

<div class="row" style="margin:.5rem 0 1rem">
  <div class="bar"><div id="level" class="fill"></div></div>
  <span class="mono" id="rms">0.000</span>
</div>

<details>
  <summary>How to fix if blocked</summary>
  <ul>
    <li>Chrome/Edge: click the <b>ðŸ”’</b> in the address bar â†’ <b>Site settings</b> â†’ Microphone: <b>Allow</b>. Then reload.</li>
    <li>Safari (macOS): Safari â†’ <b>Settings for This Websiteâ€¦</b> â†’ Microphone: <b>Allow</b>. Also macOS Settings â†’ Privacy & Security â†’ Microphone.</li>
    <li>iOS/iPadOS: Settings â†’ Safari â†’ Camera & Microphone â†’ <b>Allow</b>. Also Settings â†’ Privacy â†’ Microphone.</li>
  </ul>
</details>

<h3>Debug log</h3>
<pre id="log" class="mono"></pre>

<script>
const $ = s => document.querySelector(s);
const log = (m)=>{$('#log').textContent += m + "\n"}

const isSecure = () =>
  window.isSecureContext || location.protocol === 'https:' ||
  location.hostname === 'localhost' || location.hostname === '127.0.0.1';

$('#origin').textContent = location.origin;
$('#secure').textContent = isSecure();
$('#secure').className = isSecure() ? 'ok' : 'bad';

(async () => {
  try {
    const p = await navigator.permissions?.query?.({ name: 'microphone' });
    if (p) {
      $('#perm').textContent = p.state;
      $('#perm').className = (p.state === 'granted') ? 'ok' : (p.state === 'denied') ? 'bad' : 'warn';
      p.onchange = () => {
        $('#perm').textContent = p.state;
        $('#perm').className = (p.state === 'granted') ? 'ok' : (p.state === 'denied') ? 'bad' : 'warn';
      };
    } else {
      $('#perm').textContent = 'unsupported';
      $('#perm').className = 'muted';
    }
  } catch(e) {
    $('#perm').textContent = 'error';
    $('#perm').className = 'muted';
  }
})();

let ctx, src, analyser, buf, raf;
function startMeter(stream) {
  const AC = window.AudioContext || window.webkitAudioContext;
  ctx = new AC({ sampleRate: 16000 });
  const track = stream.getAudioTracks()[0];
  if (!track) throw new Error('NO_TRACK');
  src = ctx.createMediaStreamSource(stream);
  analyser = ctx.createAnalyser(); analyser.fftSize = 1024;
  buf = new Float32Array(analyser.fftSize);
  src.connect(analyser);

  function tick() {
    analyser.getFloatTimeDomainData(buf);
    let s=0; for (let i=0;i<buf.length;i++) s+=buf[i]*buf[i];
    const rms = Math.sqrt(s/buf.length); // ~0..1
    $('#rms').textContent = rms.toFixed(3);
    $('#level').style.width = Math.min(100, rms*200) + '%';
    raf = requestAnimationFrame(tick);
  }
  tick();
}

$('#enable').onclick = async () => {
  $('#status').textContent = 'Requesting microphoneâ€¦';
  $('#status').className = '';
  $('#log').textContent = '';

  if (!isSecure()) {
    $('#status').textContent = 'Not a secure context. Use HTTPS or http://localhost.';
    $('#status').className = 'bad';
    alert('Microphone requires HTTPS or http://localhost.\nOpen this page via GitHub Pages (HTTPS) or a local server.');
    return;
  }

  try {
    // On iOS/Safari, AudioContext must begin inside a user gesture
    const AC = window.AudioContext || window.webkitAudioContext;
    const tmp = new AC({ sampleRate: 16000 });
    if (tmp.state === 'suspended') await tmp.resume(); // gesture present
    tmp.close(); // weâ€™ll create a fresh one in startMeter

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    $('#status').textContent = 'Microphone active.';
    $('#status').className = 'ok';
    $('#enable').disabled = true; $('#stop').disabled = false;
    log('Got stream: ' + JSON.stringify(stream.getAudioTracks()[0].getSettings()));
    startMeter(stream);
  } catch (e) {
    console.error(e);
    let msg = 'Could not access the microphone.';
    if (e.name === 'NotAllowedError' || e.name === 'SecurityError') {
      msg = 'Permission denied. Click the lock icon â†’ Site settings â†’ Microphone: Allow, then reload.';
      $('#status').className = 'bad';
    } else if (e.name === 'NotFoundError' || e.message === 'NO_TRACK') {
      msg = 'No microphone found. Select a valid input device in browser settings.';
      $('#status').className = 'bad';
    } else if (e.message && e.message.includes('secure')) {
      msg = 'Secure context required. Use HTTPS or http://localhost.';
      $('#status').className = 'bad';
    } else {
      $('#status').className = 'warn';
    }
    $('#status').textContent = msg;
    alert(msg);
    log(e.name + ': ' + (e.message || ''));
  }
};

$('#stop').onclick = () => {
  cancelAnimationFrame(raf);
  try { ctx && ctx.close(); } catch(_) {}
  $('#enable').disabled = false; $('#stop').disabled = true;
  $('#status').textContent = 'Stopped.';
  $('#status').className = '';
};
</script>
