<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ShakeScore — 10s Device Motion Test (Mobile)</title>
<style>
  :root { --fg:#0f172a; --muted:#64748b; --ok:#16a34a; --bad:#ef4444; --warn:#eab308; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--fg); margin:2rem; }
  .row{ display:flex; gap:.75rem; align-items:center; flex-wrap:wrap }
  button{ padding:.7rem 1rem; font-size:1rem; border-radius:.75rem; border:1px solid #cbd5e1; background:#f8fafc; cursor:pointer }
  button.primary{ background:#111827; color:#fff; border-color:#111827 }
  button:disabled{ opacity:.6; cursor:not-allowed }
  .mono{ font-variant-numeric: tabular-nums; font-feature-settings:"tnum" }
  .ok{ color:var(--ok) } .bad{ color:var(--bad) } .warn{ color:var(--warn) } .muted{ color:var(--muted) }
  .panel{ border:1px solid #e2e8f0; border-radius:16px; padding:14px 16px; margin-top:12px }
  .bar{ height:14px; background:#e5e7eb; border-radius:999px; overflow:hidden; width:380px; max-width:100% }
  .fill{ height:100%; width:0%; background:linear-gradient(90deg,#93c5fd,#2563eb); transition:width .12s linear }
  .fill.green{ background:linear-gradient(90deg,#86efac,#16a34a) }
  pre{ background:#0b1220; color:#e5e7eb; padding:.75rem 1rem; border-radius:.5rem; overflow:auto; max-height:220px }
</style>

<h1>ShakeScore (10-second mobile shake)</h1>
<p class="muted">
  Tap <b>Start</b>, then shake for 10 seconds. Stronger shakes ⇒ higher <b>ShakeScore</b>.
  Works on modern mobile browsers. Most laptops/desktops lack motion sensors.
</p>

<div class="row">
  <button id="start" class="primary">Start 10s</button>
  <button id="stop" disabled>Stop</button>
  <button id="again" disabled>Again</button>
  <span id="status">Idle.</span>
</div>

<p>
  Secure context: <b id="secure" class="mono"></b> ·
  Origin: <span class="mono" id="origin"></span> ·
  Motion permission (iOS): <b id="perm" class="mono">n/a</b>
</p>

<div class="panel">
  <div class="row" style="margin:.5rem 0 1rem">
    <div class="bar"><div id="accBar" class="fill green"></div></div>
    <span class="mono" id="accTxt">acc 0.00 m/s²</span>
  </div>

  <div class="row" style="margin:.25rem 0 1rem">
    <div class="bar"><div id="rotBar" class="fill"></div></div>
    <span class="mono" id="rotTxt">rot 0.0 °/s</span>
  </div>

  <div class="row" style="margin:.25rem 0 1.25rem">
    <div class="bar"><div id="scoreBar" class="fill"></div></div>
    <span class="mono" id="scoreTxt">ShakeScore 0</span>
  </div>

  <div class="mono muted">Time: <span id="t">0.0</span>s</div>
</div>

<h3>Debug</h3>
<pre id="log" class="mono"></pre>

<script>
const $ = s => document.querySelector(s);
const log = m => ($('#log').textContent += m + "\n");

const isSecure = () => window.isSecureContext || location.protocol === "https:" ||
  location.hostname === "localhost" || location.hostname === "127.0.0.1";
$("#origin").textContent = location.origin;
$("#secure").textContent = isSecure();
$("#secure").className = isSecure() ? "ok" : "bad";

let running = false, haveMotion = false, timerId = 0, lastTS = 0;

// Accumulated energies
let accE = 0;   // translational “shake” energy
let rotE = 0;   // rotational energy

// live meters
let accLive = 0, rotLive = 0;

const G = 9.80665; // gravity baseline

// Robust access to acceleration vector (prefer linear; else incl gravity minus g)
function linearAccel(e){
  const a = e.acceleration;
  const ag = e.accelerationIncludingGravity;
  let ax=0, ay=0, az=0, useG = false;

  if (a && a.x !== null) { ax=a.x||0; ay=a.y||0; az=a.z||0; }
  else if (ag && ag.x !== null) { ax=ag.x||0; ay=ag.y||0; az=ag.z||0; useG = true; }
  const mag = Math.hypot(ax, ay, az);
  return useG ? Math.max(0, Math.abs(mag - G)) : mag;
}

function rotationRate(e){
  const r = e.rotationRate || {};
  const a = (r.alpha||0), b = (r.beta||0), g = (r.gamma||0); // deg/s
  return Math.hypot(a,b,g); // keep in deg/s for display; convert to rad/s for energy
}

function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }

// Main event handler
function onMotion(e){
  haveMotion = true;

  const now = (e.timeStamp && Number.isFinite(e.timeStamp)) ? e.timeStamp : performance.now();
  let dt = lastTS ? (now - lastTS)/1000 : 0;
  if (dt <= 0 || dt > 0.25) dt = 0.02; // guard: assume ~50 Hz if weird
  lastTS = now;

  const a = linearAccel(e);          // m/s^2, gravity removed if needed
  const rDeg = rotationRate(e);      // deg/s
  const rRad = rDeg * Math.PI / 180; // rad/s

  // Accumulate “energy”: sum (value^2 * dt)
  accE += (a*a) * dt;
  rotE += (rRad*rRad) * dt;

  accLive = a; rotLive = rDeg;
}

// UI updater (60 fps)
function tickUI(t, T){
  // live meters
  $("#accTxt").textContent = `acc ${accLive.toFixed(2)} m/s²`;
  $("#rotTxt").textContent = `rot ${rotLive.toFixed(1)} °/s`;
  $("#accBar").style.width = clamp(accLive*6, 0, 100) + "%"; // scale for visibility
  $("#rotBar").style.width = clamp(rotLive*0.6, 0, 100) + "%";

  // score (combine energies with a scale for rotation so it contributes meaningfully)
  const score = Math.round(accE*6 + rotE*2); // tuned empirically; bigger shake => bigger score
  $("#scoreTxt").textContent = `ShakeScore ${score}`;
  $("#scoreBar").style.width = clamp(score/5, 0, 100) + "%"; // visual only
  $("#t").textContent = (t/1000).toFixed(1);

  if (t >= T) return score;
  return null;
}

// iOS permission helper
async function ensureMotionPermission() {
  if (typeof DeviceMotionEvent === "undefined") return; // no API
  if (typeof DeviceMotionEvent.requestPermission === "function") {
    const res = await DeviceMotionEvent.requestPermission();
    $("#perm").textContent = res;
    $("#perm").className = (res === "granted") ? "ok" : (res === "denied") ? "bad" : "warn";
    if (res !== "granted") throw new Error("MOTION_DENIED");
  } else {
    $("#perm").textContent = "n/a";
    $("#perm").className = "muted";
  }
}

$("#start").onclick = async () => {
  $("#status").textContent = "Preparing…"; $("#status").className = "";
  $("#log").textContent = "";

  if (!isSecure()) {
    $("#status").textContent = "Use HTTPS or http://localhost."; $("#status").className="bad";
    alert("Motion sensors require HTTPS or http://localhost.");
    return;
  }
  try {
    await ensureMotionPermission();

    // Reset state
    running = true; haveMotion = false; accE = 0; rotE = 0; lastTS = 0; accLive = 0; rotLive = 0;
    $("#start").disabled = true; $("#again").disabled = true; $("#stop").disabled = false;

    // Listen (passive true for perf)
    window.addEventListener("devicemotion", onMotion, { passive: true });

    // If nothing arrives in 2s, tell the user (likely desktop or sensors off)
    setTimeout(() => { if (!haveMotion) { $("#status").textContent = "No motion data. This device/browser likely has no sensors (desktop) or access is disabled."; $("#status").className="warn"; } }, 2000);

    $("#status").textContent = "Shake now!";
    $("#status").className = "ok";

    // 10s round
    const T = 10_000; let t = 0; const dt = 1000/60;
    (function loop(){
      if (!running) return;
      t += dt;
      const done = tickUI(t, T);
      if (done !== null) {
        running = false;
        window.removeEventListener("devicemotion", onMotion, { passive: true });
        $("#stop").disabled = true; $("#again").disabled = false;
        $("#status").textContent = "Finished.";
        $("#status").className = "";

        // Final numbers for logs/leaderboard later
        const finalScore = Math.round(accE*6 + rotE*2);
        log(`Final ShakeScore: ${finalScore}`);
        log(`accEnergy=${accE.toFixed(3)} (m/s²)²·s, rotEnergy=${rotE.toFixed(3)} (rad/s)²·s`);
        return;
      }
      timerId = setTimeout(loop, dt);
    })();

  } catch (e) {
    console.error(e);
    let msg = "Could not start motion capture.";
    if (e.message === "MOTION_DENIED") {
      msg = "Motion access denied. In iOS: Settings → Safari → Motion & Orientation Access → On.";
      $("#status").className = "bad";
    } else {
      $("#status").className = "warn";
    }
    $("#status").textContent = msg;
    alert(msg);
  }
};

$("#stop").onclick = () => {
  running = false;
  window.removeEventListener("devicemotion", onMotion, { passive: true });
  clearTimeout(timerId);
  $("#start").disabled = false; $("#again").disabled = false; $("#stop").disabled = true;
  $("#status").textContent = "Stopped.";
  $("#status").className = "";
};

$("#again").onclick = () => {
  $("#scoreTxt").textContent = "ShakeScore 0";
  $("#accTxt").textContent = "acc 0.00 m/s²";
  $("#rotTxt").textContent = "rot 0.0 °/s";
  $("#accBar").style.width = "0%";
  $("#rotBar").style.width = "0%";
  $("#scoreBar").style.width = "0%";
  $("#t").textContent = "0.0";
  $("#log").textContent = "";
  $("#start").disabled = false; $("#again").disabled = true; $("#stop").disabled = true;
  $("#status").textContent = "Ready.";
};
</script>
</html>
